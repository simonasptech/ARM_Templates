{  
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/DeploymentTemplate.json#",  
  "contentVersion": "1.0.0.0",  
  "parameters": {  
    "location": {  
      "type": "string",  
      "metadata": {  
        "description": "Location for all resources."  
      }  
    },
    "workspaceName": {  
      "type": "string",  
      "metadata": {  
        "description": "Name of the Log Analytics Workspace."  
      }  
    },  
    "workspaceResourceGroup": {  
      "type": "string",  
      "metadata": {  
        "description": "Resource group where the Log Analytics Workspace resides."  
      }  
    },  
    "vmName": {  
      "type": "string",  
      "metadata": {  
        "description": "Name of the Virtual Machine to associate the DCR with."  
      }  
    },  
    "vmResourceGroup": {  
      "type": "string",  
      "metadata": {  
        "description": "Resource group of the Virtual Machine."  
      }  
    },  
    "vmResourceId": {  
      "type": "string",  
      "metadata": {  
        "description": "Full resource ID of the Virtual Machine (for associating the DCR)."  
      }  
    },  
    "dcrName": {  
      "type": "string",  
      "metadata": {  
        "description": "Name of the Data Collection Rule."  
      }  
    },  
    "dcrAssociationName": {  
      "type": "string",  
      "metadata": {  
        "description": "Name of the DCR Association."  
      }  
    }  
  },  
  "resources": [  
    {  
      "type": "Microsoft.Insights/dataCollectionRules",  
      "apiVersion": "2023-03-11",  
      "name": "[parameters('dcrName')]",  
      "location": "[parameters('location')]",  
      "properties": {  
        "dataSources": {  
          "syslog": [  
            {  
              "name": "syslogSource",  
              "streams": [  
                "Microsoft-Syslog"  
              ],  
              "facilityNames": [  
                "*"  
              ],  
              "logLevels": [  
                "*"  
              ]  
            }  
          ]  
        },  
        "destinations": {  
          "logAnalytics": [  
            {  
              "workspaceResourceId": "[resourceId(parameters('workspaceResourceGroup'), 'Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",  
              "name": "laDestination"  
            }  
          ]  
        },  
        "dataFlows": [  
          {  
            "streams": [  
              "Microsoft-Syslog"  
            ],  
            "destinations": [  
              "laDestination"  
            ],  
            "transformKql": "Source | extend RawLog = EventOriginal | parse RawLog with * \"subject=\\\"\" Subject \"\\\"\" * | parse RawLog with * \"device=\\\"\" DeviceName \"\\\"\" * | parse RawLog with * \"severity=\\\"\" Severity \"\\\"\" * | parse RawLog with * \"trigger=\\\"\" Trigger \"\\\"\" * | parse RawLog with * \"tag=\\\"\" Tags \"\\\"\" * | parse RawLog with * \"alertid=\" AlertId:int * | parse RawLog with * \"log=\\\"\" InnerLog | parse kind=regex InnerLog with * \"logid=\\\\\\\"?(?<LogId>[0-9]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"type=\\\\\\\"?(?<EventType>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"subtype=\\\\\\\"?(?<EventSubType>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"eventtype=\\\\\\\"?(?<EventSubTypeDetail>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"devname=\\\\\\\"(?<DeviceNameDetail>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"vd=\\\\\\\"(?<VDOM>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"eventtime=(?<EventTime>[0-9]+)\" * | parse kind=regex InnerLog with * \"srcip=\\\\\\\"?(?<SrcIP>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"srcport=(?<SrcPort>[0-9]+)\" * | parse kind=regex InnerLog with * \"srccountry=\\\\\\\"?(?<SrcCountry>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"dstip=\\\\\\\"?(?<DstIP>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"dstport=(?<DstPort>[0-9]+)\" * | parse kind=regex InnerLog with * \"dstcountry=\\\\\\\"?(?<DstCountry>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"srcintf=\\\\\\\"(?<SrcInterface>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"dstintf=\\\\\\\"(?<DstInterface>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"user=\\\\\\\"(?<User>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"ui=\\\\\\\"(?<UI>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"app=\\\\\\\"(?<Application>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"appcat=\\\\\\\"(?<AppCategory>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"apprisk=\\\\\\\"(?<AppRisk>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"hostname=\\\\\\\"(?<Hostname>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"url=\\\\\\\"(?<URL>[^\\\\\\\"]*)\\\\\\\"\" * | parse kind=regex InnerLog with * \"sni=\\\\\\\"(?<SNI>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"scertcname=\\\\\\\"(?<CertificateCN>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"scertissuer=\\\\\\\"(?<CertificateIssuer>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"cfgpath=\\\\\\\"(?<ConfigPath>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"cfgobj=\\\\\\\"(?<ConfigObject>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"cfgattr=\\\\\\\"(?<ConfigAttr>[^\\\\\\\"]+)\\\\\\\"\" * | parse kind=regex InnerLog with * \"action=\\\\\\\"?(?<Action>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"status=\\\\\\\"?(?<Status>[^\\\\s\\\"]+)\\\\\\\"?\" * | parse kind=regex InnerLog with * \"msg=\\\\\\\"(?<Msg>[^\\\\\\\"]+)\\\\\\\"\" * | project TimeGenerated, Subject, DeviceName, Severity, Trigger, Tags, AlertId, LogId, EventType, EventSubType, EventSubTypeDetail, DeviceNameDetail, VDOM, EventTime, SrcIP, SrcPort, SrcCountry, DstIP, DstPort, DstCountry, SrcInterface, DstInterface, User, UI, Application, AppCategory, AppRisk, Hostname, URL, SNI, CertificateCN, CertificateIssuer, ConfigPath, ConfigObject, ConfigAttr, Action, Status, Msg, RawLog",
            "outputStream": "Custom-fortiAlerting_CL"
          } 
        ]  
      }  
    },  
    {  
      "type": "Microsoft.Insights/dataCollectionRuleAssociations",  
      "apiVersion": "2023-03-11",  
      "name": "[parameters('dcrAssociationName')]",  
      "scope": "[parameters('vmResourceId')]",  
      "properties": {  
        "description": "Association for syslog DCR",  
        "dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))]"  
      },  
      "dependsOn": [  
        "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))]"  
      ]  
    }  
  ],  
  "outputs": {  
    "dcrId": {  
      "type": "string",  
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))]"  
    },  
    "dcrAssociationId": {  
      "type": "string",  
      "value": "[extensionResourceId(parameters('vmResourceId'), 'Microsoft.Insights/dataCollectionRuleAssociations', parameters('dcrAssociationName'))]"  
    },  
    "resolvedVmResourceId": {  
      "type": "string",  
      "value": "[resourceId(parameters('vmResourceGroup'), 'Microsoft.Compute/virtualMachines', parameters('vmName'))]"  
    }  
  }  
}  